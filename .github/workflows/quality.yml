name: Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for forbidden patterns
      run: |
        echo "Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" --include="*.js" core/ tools/ bin/ 2>/dev/null; then
          echo "ERROR: TODO/FIXME comments found"
          exit 1
        fi
        echo "No TODO/FIXME patterns found"

    - name: Check for empty functions
      run: |
        echo "Checking for empty function bodies..."
        if grep -r "{\s*}" --include="*.js" core/ tools/ bin/ 2>/dev/null; then
          echo "Potential empty function bodies detected - verifying with AST policy"
        fi
        echo "Check complete"

  security-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security verification
      run: npm run security:audit

    - name: Check npm audit
      run: npm audit --audit-level=high || echo "Audit complete"

  ast-policy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Verify AST policy
      run: npm test

    - name: Run comprehensive verification
      run: npm run verify
