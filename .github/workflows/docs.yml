name: Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**.md'
      - 'docs/**'

jobs:
  markdown-lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Lint markdown
      run: |
        npx markdownlint-cli '**/*.md' --fix
        git diff --exit-code || exit 1

    - name: Check links in markdown
      run: npx markdown-link-check README.md CONTRIBUTING.md SECURITY.md || true

  docs-validation:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Validate documentation structure
      run: |
        test -f README.md || exit 1
        test -f CONTRIBUTING.md || exit 1
        test -f SECURITY.md || exit 1
        echo "Documentation structure valid"

    - name: Check for broken references
      run: |
        if grep -r "]\(#" *.md | grep -v "github.com" > /tmp/refs.txt 2>/dev/null; then
          while IFS= read -r line; do
            if ! grep -q "^##" README.md 2>/dev/null; then
              echo "Warning: Potential broken reference: $line"
            fi
          done < /tmp/refs.txt
        fi
        echo "Reference check complete"
