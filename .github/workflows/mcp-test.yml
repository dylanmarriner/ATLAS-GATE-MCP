name: MCP Server Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-servers:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test Windsurf server startup
      run: |
        timeout 10s node bin/kaiza-mcp-windsurf.js &
        sleep 3
        if ps aux | grep -v grep | grep kaiza-mcp-windsurf > /dev/null; then
          echo "Windsurf server started successfully"
          kill %1 2>/dev/null || true
        else
          echo "Windsurf server failed to start"
          exit 1
        fi

    - name: Test Antigravity server startup
      run: |
        timeout 10s node bin/kaiza-mcp-antigravity.js &
        sleep 3
        if ps aux | grep -v grep | grep kaiza-mcp-antigravity > /dev/null; then
          echo "Antigravity server started successfully"
          kill %1 2>/dev/null || true
        else
          echo "Antigravity server failed to start"
          exit 1
        fi

    - name: Test server binaries exist and are executable
      run: |
        test -x bin/kaiza-mcp-windsurf.js && echo "Windsurf binary OK"
        test -x bin/kaiza-mcp-antigravity.js && echo "Antigravity binary OK"
